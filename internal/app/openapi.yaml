openapi: 3.0.3
info:
  title: Neo-Metric Instagram API
  description: |
    API для взаимодействия с Instagram Graph API.

    Поддерживает:
    - Создание, редактирование и удаление публикаций (Post, Story, Reel)
    - Отложенный постинг (scheduling)
    - Немедленную публикацию
    - Управление комментариями
    - Direct Messages (Директ)
    - Шаблоны сообщений

    ## Статусы публикаций

    | Статус | Описание |
    |--------|----------|
    | `draft` | Черновик, не запланирован |
    | `scheduled` | Запланирован на определённое время |
    | `published` | Успешно опубликован в Instagram |
    | `error` | Ошибка при публикации |

    ## Типы публикаций

    | Тип | Описание | Ограничения |
    |-----|----------|-------------|
    | `post` | Обычный пост в ленту | До 10 медиафайлов (карусель) |
    | `story` | История | Ровно 1 медиафайл |
    | `reel` | Reels видео | Ровно 1 видеофайл |

  version: 1.0.0
  contact:
    name: Vadim Galkin

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.example.com/api/v1
    description: Production server

tags:
  - name: Accounts
    description: Instagram аккаунты
  - name: Media
    description: Загрузка медиафайлов
  - name: Publications
    description: Управление публикациями Instagram
  - name: Comments
    description: Управление комментариями Instagram
  - name: Direct
    description: Direct Messages (личные сообщения Instagram)
  - name: Templates
    description: Шаблоны сообщений для Direct и Comments
  - name: Health
    description: Проверка состояния сервиса

paths:
  /healthz:
    get:
      tags:
        - Health
      summary: Health check
      description: Проверка работоспособности сервиса
      operationId: healthCheck
      responses:
        '200':
          description: Сервис работает
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /readyz:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Проверка готовности сервиса к обработке запросов
      operationId: readinessCheck
      responses:
        '200':
          description: Сервис готов
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready

  /accounts:
    get:
      tags:
        - Accounts
      summary: Список Instagram аккаунтов
      description: |
        Получить список всех подключённых Instagram аккаунтов.

        Возвращает информацию о наличии активного access token.
      operationId: listAccounts
      responses:
        '200':
          description: Список аккаунтов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountListResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /accounts/{id}:
    get:
      tags:
        - Accounts
      summary: Получить аккаунт
      description: Получить информацию об Instagram аккаунте по ID
      operationId: getAccount
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Аккаунт найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '404':
          description: Аккаунт не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /media/upload:
    post:
      tags:
        - Media
      summary: Загрузить медиафайл
      description: |
        Загружает медиафайл в хранилище и возвращает публичный URL.

        Поддерживаемые форматы:
        - Изображения: JPEG, PNG, GIF, WebP
        - Видео: MP4, MOV

        Максимальный размер файла: 50 МБ
      operationId: uploadMedia
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Медиафайл для загрузки
      responses:
        '201':
          description: Файл успешно загружен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MediaUploadResponse'
        '400':
          description: Неверный запрос (неподдерживаемый формат или файл слишком большой)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications:
    post:
      tags:
        - Publications
      summary: Создать публикацию
      description: |
        Создаёт новую публикацию (черновик или запланированную).

        Если указан `scheduled_at`, публикация будет запланирована на это время.
        Иначе создаётся черновик.
      operationId: createPublication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePublicationRequest'
            examples:
              post:
                summary: Создание поста
                value:
                  account_id: "acc_123"
                  type: "post"
                  caption: "Новый пост! #instagram #api"
                  media:
                    - url: "https://example.com/image1.jpg"
                      type: "image"
                      order: 0
                  scheduled_at: "2025-12-25T10:00:00Z"
              story:
                summary: Создание истории
                value:
                  account_id: "acc_123"
                  type: "story"
                  media:
                    - url: "https://example.com/story.jpg"
                      type: "image"
                      order: 0
              reel:
                summary: Создание Reel
                value:
                  account_id: "acc_123"
                  type: "reel"
                  caption: "Мой первый Reel!"
                  media:
                    - url: "https://example.com/video.mp4"
                      type: "video"
                      order: 0
              carousel:
                summary: Создание карусели
                value:
                  account_id: "acc_123"
                  type: "post"
                  caption: "Карусель изображений"
                  media:
                    - url: "https://example.com/image1.jpg"
                      type: "image"
                      order: 0
                    - url: "https://example.com/image2.jpg"
                      type: "image"
                      order: 1
                    - url: "https://example.com/image3.jpg"
                      type: "image"
                      order: 2
      responses:
        '201':
          description: Публикация создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Publications
      summary: Список публикаций
      description: |
        Получить список публикаций с возможностью фильтрации и пагинации.

        Публикации отсортированы по `scheduled_at` (новые сверху).
      operationId: listPublications
      parameters:
        - name: account_id
          in: query
          description: Фильтр по ID аккаунта
          schema:
            type: string
          example: acc_123
        - name: type
          in: query
          description: Фильтр по типу публикации
          schema:
            $ref: '#/components/schemas/PublicationType'
        - name: status
          in: query
          description: Фильтр по статусу
          schema:
            $ref: '#/components/schemas/PublicationStatus'
        - name: year
          in: query
          description: Фильтр по году (для календаря)
          schema:
            type: integer
            example: 2025
        - name: month
          in: query
          description: Фильтр по месяцу (1-12, для календаря)
          schema:
            type: integer
            minimum: 1
            maximum: 12
            example: 12
        - name: limit
          in: query
          description: Количество записей на страницу (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Смещение для пагинации
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Список публикаций
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicationListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications/{id}:
    get:
      tags:
        - Publications
      summary: Получить публикацию
      description: Получить публикацию по ID
      operationId: getPublication
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      responses:
        '200':
          description: Публикация найдена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      tags:
        - Publications
      summary: Обновить публикацию
      description: |
        Обновить существующую публикацию.

        **Важно:** Можно обновлять только публикации со статусом `draft` или `scheduled`.
      operationId: updatePublication
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePublicationRequest'
            examples:
              updateCaption:
                summary: Обновить текст
                value:
                  caption: "Обновлённый текст публикации"
              reschedule:
                summary: Перенести время
                value:
                  scheduled_at: "2025-12-26T15:00:00Z"
              toDraft:
                summary: Убрать из расписания
                value:
                  clear_schedule: true
      responses:
        '200':
          description: Публикация обновлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Публикацию нельзя редактировать (уже опубликована)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Publications
      summary: Удалить публикацию
      description: |
        Удалить публикацию из базы данных.

        **Важно:** Instagram Graph API не поддерживает удаление опубликованного контента.
        Если публикация уже была размещена в Instagram, она останется там и должна быть
        удалена вручную через приложение Instagram.
      operationId: deletePublication
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      responses:
        '204':
          description: Публикация удалена из базы данных
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications/{id}/publish:
    post:
      tags:
        - Publications
      summary: Опубликовать сейчас
      description: |
        Немедленно опубликовать публикацию в Instagram.

        Работает для публикаций со статусом `draft` или `scheduled`.
      operationId: publishNow
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      responses:
        '200':
          description: Публикация опубликована
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Публикацию нельзя опубликовать
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Превышен лимит публикаций Instagram (25 в день)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications/{id}/schedule:
    post:
      tags:
        - Publications
      summary: Запланировать публикацию
      description: |
        Запланировать публикацию на определённое время.

        Время должно быть в будущем.
      operationId: schedulePublication
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - scheduled_at
              properties:
                scheduled_at:
                  type: string
                  format: date-time
                  description: Время публикации (RFC3339)
                  example: "2025-12-25T10:00:00Z"
      responses:
        '200':
          description: Публикация запланирована
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Публикацию нельзя запланировать
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications/{id}/draft:
    post:
      tags:
        - Publications
      summary: Сохранить как черновик
      description: |
        Убрать публикацию из расписания и сохранить как черновик.

        Очищает `scheduled_at` и устанавливает статус `draft`.
      operationId: saveAsDraft
      parameters:
        - $ref: '#/components/parameters/PublicationId'
      responses:
        '200':
          description: Публикация сохранена как черновик
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Publication'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Публикацию нельзя перевести в черновик
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /publications/statistics:
    get:
      tags:
        - Publications
      summary: Статистика публикаций
      description: |
        Получить агрегированную статистику публикаций для аккаунта.

        **Включает:**
        - Количество запланированных публикаций
        - Количество опубликованных
        - Количество с ошибками
        - Количество черновиков
        - Разбивка по типам (post/story/reel)
      operationId: getPublicationStatistics
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
      responses:
        '200':
          description: Статистика публикаций
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicationStatistics'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # Comments API
  # ============================================================================

  /comments/statistics:
    get:
      tags:
        - Comments
      summary: Статистика комментариев
      description: |
        Получить агрегированную статистику комментариев для аккаунта.

        **Включает:**
        - Общее количество комментариев
        - Количество ответов от аккаунта
        - Среднее количество комментариев на пост
        - Топ публикаций по количеству комментариев
      operationId: getCommentStatistics
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: top_posts_limit
          in: query
          description: Количество топ-постов (макс. 20)
          schema:
            type: integer
            default: 5
            minimum: 1
            maximum: 20
      responses:
        '200':
          description: Статистика комментариев
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentStatistics'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /comments/media/{mediaId}:
    get:
      tags:
        - Comments
      summary: Получить комментарии медиа
      description: |
        Получить список комментариев для указанного медиа в Instagram.

        Поддерживает курсорную пагинацию.
      operationId: getComments
      parameters:
        - name: mediaId
          in: path
          required: true
          description: ID медиа в Instagram
          schema:
            type: string
          example: "17895695668004550"
        - name: account_id
          in: query
          required: true
          description: ID аккаунта для авторизации
          schema:
            type: string
          example: "acc_123"
        - name: limit
          in: query
          description: Количество комментариев (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: after
          in: query
          description: Курсор для пагинации
          schema:
            type: string
      responses:
        '200':
          description: Список комментариев
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Медиа не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Comments
      summary: Создать комментарий
      description: |
        Создать новый комментарий к медиа в Instagram.

        **Ограничения:**
        - Максимальная длина текста: 2200 символов
        - Комментирование должно быть включено для медиа
      operationId: createComment
      parameters:
        - name: mediaId
          in: path
          required: true
          description: ID медиа в Instagram
          schema:
            type: string
          example: "17895695668004550"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCommentRequest'
      responses:
        '201':
          description: Комментарий создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateCommentResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Комментирование отключено для этого медиа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Медиа не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /comments/{commentId}/replies:
    get:
      tags:
        - Comments
      summary: Получить ответы на комментарий
      description: |
        Получить список ответов на указанный комментарий.

        Поддерживает курсорную пагинацию.
      operationId: getReplies
      parameters:
        - $ref: '#/components/parameters/CommentId'
        - name: account_id
          in: query
          required: true
          description: ID аккаунта для авторизации
          schema:
            type: string
          example: "acc_123"
        - name: limit
          in: query
          description: Количество ответов (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: after
          in: query
          description: Курсор для пагинации
          schema:
            type: string
      responses:
        '200':
          description: Список ответов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Комментарий не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Comments
      summary: Ответить на комментарий
      description: |
        Создать ответ на комментарий.

        **Ограничения:**
        - Максимальная длина текста: 2200 символов

        **Send to Direct:**
        При указании `send_to_direct: true` ответ также будет отправлен автору комментария в директ.
        Для этого необходимо, чтобы комментарий был синхронизирован с сохранением author_id.
        Ошибки отправки DM не влияют на создание ответа на комментарий.
      operationId: replyToComment
      parameters:
        - $ref: '#/components/parameters/CommentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplyRequest'
      responses:
        '201':
          description: Ответ создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReplyResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Комментарий не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /comments/{commentId}:
    delete:
      tags:
        - Comments
      summary: Удалить комментарий
      description: |
        Удалить комментарий из Instagram.

        Можно удалить только свои комментарии или комментарии на своём медиа.
      operationId: deleteComment
      parameters:
        - $ref: '#/components/parameters/CommentId'
        - name: account_id
          in: query
          required: true
          description: ID аккаунта для авторизации
          schema:
            type: string
          example: "acc_123"
      responses:
        '204':
          description: Комментарий удалён
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Нет прав на удаление комментария
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Комментарий не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /comments/{commentId}/hide:
    post:
      tags:
        - Comments
      summary: Скрыть/показать комментарий
      description: |
        Скрыть или показать комментарий.

        Скрытые комментарии не видны другим пользователям, но видны автору.
      operationId: hideComment
      parameters:
        - $ref: '#/components/parameters/CommentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HideCommentRequest'
      responses:
        '200':
          description: Статус комментария изменён
          content:
            application/json:
              schema:
                type: object
                properties:
                  hidden:
                    type: boolean
                    description: Текущее состояние скрытия
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Невалидный access token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Нет прав на скрытие комментария
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Комментарий не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # Direct Messages API
  # ============================================================================

  /direct/conversations:
    get:
      tags:
        - Direct
      summary: Список диалогов
      description: |
        Получить список диалогов Direct для указанного аккаунта.

        Диалоги синхронизируются фоновым процессом и возвращаются из локальной БД.
      operationId: getConversations
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: limit
          in: query
          description: Количество диалогов (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Смещение для пагинации
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Список диалогов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/conversations/sync:
    post:
      tags:
        - Direct
      summary: Синхронизировать диалоги
      description: |
        Вручную запустить синхронизацию списка диалогов с Instagram.

        Используйте этот endpoint, если нужно немедленно получить новые диалоги,
        не дожидаясь плановой синхронизации.
      operationId: syncConversations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncRequest'
      responses:
        '200':
          description: Синхронизация выполнена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/conversations/search:
    get:
      tags:
        - Direct
      summary: Поиск диалогов
      description: |
        Поиск диалогов по имени пользователя, имени участника или тексту сообщений.

        Использует полнотекстовый поиск по локальной БД.
      operationId: searchConversations
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: q
          in: query
          required: true
          description: Поисковый запрос
          schema:
            type: string
            minLength: 1
          example: "john"
        - name: limit
          in: query
          description: Количество результатов (макс. 50)
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 50
      responses:
        '200':
          description: Результаты поиска
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/conversations/{conversationId}/messages:
    get:
      tags:
        - Direct
      summary: Сообщения диалога
      description: |
        Получить сообщения диалога.

        При первом открытии диалога выполняется синхронизация с Instagram API.
        Последующие запросы возвращают данные из локальной БД.
      operationId: getMessages
      parameters:
        - $ref: '#/components/parameters/ConversationId'
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: limit
          in: query
          description: Количество сообщений (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: before
          in: query
          description: Получить сообщения до указанного timestamp
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Список сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Диалог не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Direct
      summary: Отправить текстовое сообщение
      description: |
        Отправить текстовое сообщение в диалог.

        Сообщение отправляется через Instagram API и сохраняется в локальной БД.
      operationId: sendMessage
      parameters:
        - $ref: '#/components/parameters/ConversationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '201':
          description: Сообщение отправлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Диалог не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Превышен лимит сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/conversations/{conversationId}/messages/sync:
    post:
      tags:
        - Direct
      summary: Синхронизировать сообщения диалога
      description: |
        Вручную запустить синхронизацию сообщений конкретного диалога с Instagram.

        Удаляет текущий статус синхронизации и выполняет полную синхронизацию сообщений.
        Используйте этот endpoint, если нужно немедленно получить новые сообщения.
      operationId: syncMessages
      parameters:
        - $ref: '#/components/parameters/ConversationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncRequest'
      responses:
        '200':
          description: Синхронизация выполнена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Диалог не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/conversations/{conversationId}/media:
    post:
      tags:
        - Direct
      summary: Отправить медиа-сообщение
      description: |
        Отправить изображение, видео или аудио в диалог.

        **Поддерживаемые типы:**
        - `image` - изображение
        - `video` - видео
        - `audio` - голосовое сообщение
      operationId: sendMediaMessage
      parameters:
        - $ref: '#/components/parameters/ConversationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMediaMessageRequest'
      responses:
        '201':
          description: Сообщение отправлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Диалог не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Превышен лимит сообщений
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/statistics:
    get:
      tags:
        - Direct
      summary: Статистика Direct Messages
      description: |
        Получить статистику по Direct Messages за указанный период.

        **Включает:**
        - Общее количество диалогов
        - Новые диалоги за период
        - Количество уникальных пользователей
        - Среднее время первого ответа
        - Среднее время ответа
        - Самый активный день недели
        - Самый активный временной слот
        - Всего отправлено/получено сообщений
      operationId: getDirectStatistics
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: from
          in: query
          required: true
          description: Начало периода
          schema:
            type: string
            format: date-time
          example: "2025-01-01T00:00:00Z"
        - name: to
          in: query
          required: true
          description: Конец периода
          schema:
            type: string
            format: date-time
          example: "2025-01-31T23:59:59Z"
      responses:
        '200':
          description: Статистика
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectStatistics'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /direct/heatmap:
    get:
      tags:
        - Direct
      summary: Тепловая карта сообщений
      description: |
        Получить тепловую карту активности сообщений.

        Возвращает количество сообщений по дням недели (0-6) и часам (0-23).
      operationId: getDirectHeatmap
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: from
          in: query
          required: true
          description: Начало периода
          schema:
            type: string
            format: date-time
          example: "2025-01-01T00:00:00Z"
        - name: to
          in: query
          required: true
          description: Конец периода
          schema:
            type: string
            format: date-time
          example: "2025-01-31T23:59:59Z"
      responses:
        '200':
          description: Тепловая карта
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectHeatmap'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # Templates API
  # ============================================================================

  /templates:
    get:
      tags:
        - Templates
      summary: Список шаблонов
      description: |
        Получить список шаблонов сообщений.

        Можно фильтровать по типу: `direct`, `comment`, `both`.
      operationId: listTemplates
      parameters:
        - name: account_id
          in: query
          required: true
          description: ID аккаунта
          schema:
            type: string
          example: "acc_123"
        - name: type
          in: query
          description: Фильтр по типу шаблона
          schema:
            $ref: '#/components/schemas/TemplateType'
        - name: limit
          in: query
          description: Количество шаблонов (макс. 100)
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          description: Смещение для пагинации
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Список шаблонов
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplatesResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Templates
      summary: Создать шаблон
      description: |
        Создать новый шаблон сообщения.

        **Типы шаблонов:**
        - `direct` - только для Direct Messages
        - `comment` - только для комментариев
        - `both` - для обоих типов
      operationId: createTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '201':
          description: Шаблон создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /templates/{templateId}:
    get:
      tags:
        - Templates
      summary: Получить шаблон
      description: Получить шаблон по ID
      operationId: getTemplate
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '200':
          description: Шаблон найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      tags:
        - Templates
      summary: Обновить шаблон
      description: Обновить существующий шаблон
      operationId: updateTemplate
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTemplateRequest'
      responses:
        '200':
          description: Шаблон обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Templates
      summary: Удалить шаблон
      description: Удалить шаблон по ID
      operationId: deleteTemplate
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '204':
          description: Шаблон удалён
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /templates/{templateId}/use:
    post:
      tags:
        - Templates
      summary: Отметить использование шаблона
      description: |
        Увеличить счётчик использования шаблона.

        Вызывается при отправке сообщения с использованием шаблона.
      operationId: useTemplate
      parameters:
        - $ref: '#/components/parameters/TemplateId'
      responses:
        '200':
          description: Счётчик увеличен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          description: Шаблон не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  schemas:
    Account:
      type: object
      required:
        - id
        - instagram_user_id
        - username
        - has_access_token
      properties:
        id:
          type: string
          description: Внутренний ID аккаунта
          example: "acc_123"
        instagram_user_id:
          type: string
          description: ID пользователя в Instagram API
          example: "17841400123456789"
        username:
          type: string
          description: Имя пользователя Instagram
          example: "my_instagram_account"
        has_access_token:
          type: boolean
          description: Наличие активного access token
          example: true

    AccountListResponse:
      type: object
      required:
        - accounts
        - total
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/Account'
        total:
          type: integer
          description: Общее количество аккаунтов
          example: 3

    MediaUploadResponse:
      type: object
      required:
        - url
        - key
        - size
      properties:
        url:
          type: string
          format: uri
          description: Публичный URL загруженного файла
          example: "http://localhost:9000/media/2025/01/15/abc123.jpg"
        key:
          type: string
          description: Ключ объекта в хранилище
          example: "2025/01/15/abc123.jpg"
        size:
          type: integer
          format: int64
          description: Размер файла в байтах
          example: 1048576

    PublicationType:
      type: string
      enum:
        - post
        - story
        - reel
      description: |
        Тип публикации:
        * `post` - Пост в ленту (до 10 медиа)
        * `story` - История (1 медиа)
        * `reel` - Reels видео (1 видео)

    PublicationStatus:
      type: string
      enum:
        - draft
        - scheduled
        - published
        - error
      description: |
        Статус публикации:
        * `draft` - Черновик
        * `scheduled` - Запланирована
        * `published` - Опубликована
        * `error` - Ошибка публикации

    MediaType:
      type: string
      enum:
        - image
        - video
      description: Тип медиафайла

    MediaItem:
      type: object
      required:
        - id
        - url
        - type
        - order
      properties:
        id:
          type: string
          description: Уникальный идентификатор медиа
          example: "med_abc123"
        url:
          type: string
          format: uri
          description: URL медиафайла
          example: "https://storage.example.com/images/photo.jpg"
        type:
          $ref: '#/components/schemas/MediaType'
        order:
          type: integer
          description: Порядок в карусели (начиная с 0)
          minimum: 0
          example: 0
        created_at:
          type: string
          format: date-time
          description: Дата создания

    Publication:
      type: object
      required:
        - id
        - account_id
        - type
        - status
        - media
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: Уникальный идентификатор публикации
          example: "pub_xyz789"
        account_id:
          type: string
          description: ID Instagram аккаунта
          example: "acc_123"
        instagram_media_id:
          type: string
          description: ID медиа в Instagram (после публикации)
          example: "17895695668004550"
        type:
          $ref: '#/components/schemas/PublicationType'
        status:
          $ref: '#/components/schemas/PublicationStatus'
        caption:
          type: string
          description: Текст публикации (до 2200 символов)
          maxLength: 2200
          example: "Мой новый пост! #instagram"
        media:
          type: array
          items:
            $ref: '#/components/schemas/MediaItem'
          minItems: 1
          maxItems: 10
          description: Массив медиафайлов
        scheduled_at:
          type: string
          format: date-time
          nullable: true
          description: Запланированное время публикации
          example: "2025-12-25T10:00:00Z"
        published_at:
          type: string
          format: date-time
          nullable: true
          description: Фактическое время публикации
          example: "2025-12-25T10:00:05Z"
        error_message:
          type: string
          nullable: true
          description: Сообщение об ошибке (если status=error)
          example: "Instagram API rate limit exceeded"
        created_at:
          type: string
          format: date-time
          description: Дата создания
        updated_at:
          type: string
          format: date-time
          description: Дата последнего обновления

    CreatePublicationRequest:
      type: object
      required:
        - account_id
        - type
        - media
      properties:
        account_id:
          type: string
          description: ID Instagram аккаунта
          example: "acc_123"
        type:
          $ref: '#/components/schemas/PublicationType'
        caption:
          type: string
          description: Текст публикации
          maxLength: 2200
          example: "Мой новый пост!"
        media:
          type: array
          items:
            type: object
            required:
              - url
              - type
              - order
            properties:
              url:
                type: string
                format: uri
                description: URL медиафайла
              type:
                $ref: '#/components/schemas/MediaType'
              order:
                type: integer
                description: Порядок в карусели
                minimum: 0
          minItems: 1
          maxItems: 10
        scheduled_at:
          type: string
          format: date-time
          nullable: true
          description: Время публикации (если не указано - создаётся черновик)
          example: "2025-12-25T10:00:00Z"

    UpdatePublicationRequest:
      type: object
      properties:
        caption:
          type: string
          description: Новый текст публикации
          maxLength: 2200
        media:
          type: array
          items:
            type: object
            required:
              - url
              - type
              - order
            properties:
              url:
                type: string
                format: uri
              type:
                $ref: '#/components/schemas/MediaType'
              order:
                type: integer
                minimum: 0
          minItems: 1
          maxItems: 10
          description: Новый список медиафайлов (заменяет существующие)
        scheduled_at:
          type: string
          format: date-time
          nullable: true
          description: Новое время публикации
        clear_schedule:
          type: boolean
          default: false
          description: Убрать из расписания (перевести в draft)

    PublicationListResponse:
      type: object
      required:
        - publications
        - total
        - limit
        - offset
      properties:
        publications:
          type: array
          items:
            $ref: '#/components/schemas/Publication'
        total:
          type: integer
          description: Общее количество публикаций (с учётом фильтров)
          example: 42
        limit:
          type: integer
          description: Размер страницы
          example: 50
        offset:
          type: integer
          description: Текущее смещение
          example: 0

    PublicationStatistics:
      type: object
      required:
        - scheduled_count
        - published_count
        - error_count
        - draft_count
        - by_type
      properties:
        scheduled_count:
          type: integer
          description: Количество запланированных публикаций
          example: 5
        published_count:
          type: integer
          description: Количество успешно опубликованных
          example: 42
        error_count:
          type: integer
          description: Количество публикаций с ошибками
          example: 2
        draft_count:
          type: integer
          description: Количество черновиков
          example: 3
        by_type:
          $ref: '#/components/schemas/PublicationTypeBreakdown'

    PublicationTypeBreakdown:
      type: object
      required:
        - post
        - story
        - reel
      properties:
        post:
          $ref: '#/components/schemas/PublicationTypeStats'
        story:
          $ref: '#/components/schemas/PublicationTypeStats'
        reel:
          $ref: '#/components/schemas/PublicationTypeStats'

    PublicationTypeStats:
      type: object
      required:
        - scheduled_count
        - published_count
        - error_count
        - draft_count
      properties:
        scheduled_count:
          type: integer
          description: Запланировано
          example: 2
        published_count:
          type: integer
          description: Опубликовано
          example: 15
        error_count:
          type: integer
          description: С ошибками
          example: 0
        draft_count:
          type: integer
          description: Черновики
          example: 1

    CommentStatistics:
      type: object
      required:
        - total_comments
        - replied_comments
        - avg_comments_per_post
        - top_posts
      properties:
        total_comments:
          type: integer
          format: int64
          description: Общее количество комментариев
          example: 1250
        replied_comments:
          type: integer
          format: int64
          description: Количество ответов от аккаунта
          example: 320
        avg_comments_per_post:
          type: number
          format: float
          description: Среднее количество комментариев на пост
          example: 25.5
        top_posts:
          type: array
          items:
            $ref: '#/components/schemas/TopPost'
          description: Топ публикаций по количеству комментариев

    TopPost:
      type: object
      required:
        - media_id
        - comments_count
      properties:
        media_id:
          type: string
          description: ID медиа в Instagram
          example: "17895695668004550"
        caption:
          type: string
          description: Текст публикации
          example: "Мой новый пост!"
        thumbnail:
          type: string
          format: uri
          description: URL миниатюры
          example: "https://instagram.com/thumbnail.jpg"
        comments_count:
          type: integer
          format: int64
          description: Количество комментариев
          example: 156

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Сообщение об ошибке
          example: "publication not found"

    # Comment schemas
    Comment:
      type: object
      required:
        - id
        - username
        - text
        - timestamp
      properties:
        id:
          type: string
          description: ID комментария в Instagram
          example: "17895695668004551"
        media_id:
          type: string
          description: ID медиа, к которому относится комментарий
          example: "17895695668004550"
        username:
          type: string
          description: Имя пользователя автора комментария
          example: "user123"
        text:
          type: string
          description: Текст комментария
          example: "Отличное фото!"
        timestamp:
          type: string
          format: date-time
          description: Время создания комментария
        like_count:
          type: integer
          description: Количество лайков
          example: 5
        hidden:
          type: boolean
          description: Скрыт ли комментарий
          example: false
        parent_id:
          type: string
          description: ID родительского комментария (для ответов)
          example: "17895695668004552"
        replies_count:
          type: integer
          description: Количество ответов на комментарий
          example: 3
        reply_to_username:
          type: string
          description: Имя пользователя, которому адресован ответ

    CommentsResponse:
      type: object
      required:
        - comments
        - has_more
      properties:
        comments:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
        next_cursor:
          type: string
          description: Курсор для следующей страницы
        has_more:
          type: boolean
          description: Есть ли ещё комментарии

    CreateCommentRequest:
      type: object
      required:
        - account_id
        - message
      properties:
        account_id:
          type: string
          description: ID аккаунта для авторизации
          example: "acc_123"
        message:
          type: string
          description: Текст комментария
          maxLength: 2200
          example: "Отличный пост!"

    ReplyRequest:
      type: object
      required:
        - account_id
        - message
      properties:
        account_id:
          type: string
          description: ID аккаунта для авторизации
          example: "acc_123"
        message:
          type: string
          description: Текст ответа
          maxLength: 2200
          example: "Спасибо!"
        send_to_direct:
          type: boolean
          description: |
            Если true, ответ также будет отправлен автору комментария в директ.
            Требуется, чтобы author_id комментария был доступен в базе данных.
          default: false
          example: true

    ReplyResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          description: ID созданного ответа
          example: "17890123456789012"
        direct_sent:
          type: boolean
          description: Был ли отправлен DM автору комментария
          example: true
        direct_error:
          type: string
          description: Ошибка при отправке DM (если была)
          example: "comment author ID not available"

    CreateCommentResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          description: ID созданного комментария
          example: "17895695668004553"

    HideCommentRequest:
      type: object
      required:
        - account_id
        - hide
      properties:
        account_id:
          type: string
          description: ID аккаунта для авторизации
          example: "acc_123"
        hide:
          type: boolean
          description: true - скрыть, false - показать
          example: true

    # Direct Messages schemas
    SyncRequest:
      type: object
      required:
        - account_id
      properties:
        account_id:
          type: string
          description: ID аккаунта
          example: "7"

    SyncResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Статус синхронизации
          example: "synced"

    Conversation:
      type: object
      required:
        - id
        - account_id
        - participant_id
        - participant_username
      properties:
        id:
          type: string
          description: ID диалога в Instagram
          example: "aWdtOjE3ODQxNDAw"
        account_id:
          type: string
          description: ID аккаунта
          example: "acc_123"
        participant_id:
          type: string
          description: ID участника диалога
          example: "17841400123456789"
        participant_username:
          type: string
          description: Username участника
          example: "john_doe"
        participant_name:
          type: string
          description: Имя участника
          example: "John Doe"
        participant_avatar_url:
          type: string
          format: uri
          description: URL аватара участника
          example: "https://instagram.com/avatar.jpg"
        participant_followers_count:
          type: integer
          description: Количество подписчиков участника
          example: 1500
        last_message_text:
          type: string
          description: Текст последнего сообщения
          example: "Привет!"
        last_message_at:
          type: string
          format: date-time
          description: Время последнего сообщения
        unread_count:
          type: integer
          description: Количество непрочитанных сообщений
          example: 2
        created_at:
          type: string
          format: date-time
          description: Дата создания записи
        updated_at:
          type: string
          format: date-time
          description: Дата обновления записи

    ConversationsResponse:
      type: object
      required:
        - conversations
        - total
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
        total:
          type: integer
          description: Общее количество диалогов
          example: 42
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    MessageType:
      type: string
      enum:
        - text
        - image
        - video
        - audio
        - story_mention
      description: |
        Тип сообщения:
        * `text` - Текстовое сообщение
        * `image` - Изображение
        * `video` - Видео
        * `audio` - Голосовое сообщение
        * `story_mention` - Упоминание в истории

    Message:
      type: object
      required:
        - id
        - conversation_id
        - sender_id
        - type
        - is_from_me
        - timestamp
      properties:
        id:
          type: string
          description: ID сообщения в Instagram
          example: "aWdtOjE3ODQxNDAx"
        conversation_id:
          type: string
          description: ID диалога
          example: "aWdtOjE3ODQxNDAw"
        sender_id:
          type: string
          description: ID отправителя
          example: "17841400123456789"
        type:
          $ref: '#/components/schemas/MessageType'
        text:
          type: string
          description: Текст сообщения
          example: "Привет! Как дела?"
        media_url:
          type: string
          format: uri
          description: URL медиафайла (для image/video/audio)
          example: "https://instagram.com/media.jpg"
        media_type:
          type: string
          description: MIME-тип медиафайла
          example: "image/jpeg"
        is_from_me:
          type: boolean
          description: Сообщение от владельца аккаунта
          example: true
        timestamp:
          type: string
          format: date-time
          description: Время отправки сообщения

    MessagesResponse:
      type: object
      required:
        - messages
        - has_more
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        has_more:
          type: boolean
          description: Есть ли ещё сообщения

    SendMessageRequest:
      type: object
      required:
        - account_id
        - text
      properties:
        account_id:
          type: string
          description: ID аккаунта
          example: "acc_123"
        text:
          type: string
          description: Текст сообщения
          maxLength: 1000
          example: "Привет!"

    SendMediaMessageRequest:
      type: object
      required:
        - account_id
        - media_url
        - media_type
      properties:
        account_id:
          type: string
          description: ID аккаунта
          example: "acc_123"
        media_url:
          type: string
          format: uri
          description: URL медиафайла
          example: "https://storage.example.com/image.jpg"
        media_type:
          type: string
          enum:
            - image
            - video
            - audio
          description: Тип медиафайла

    DirectStatistics:
      type: object
      required:
        - total_dialogs
        - new_dialogs
        - unique_users
        - total_messages_sent
        - total_messages_received
      properties:
        total_dialogs:
          type: integer
          description: Общее количество диалогов
          example: 150
        new_dialogs:
          type: integer
          description: Новые диалоги за период
          example: 25
        unique_users:
          type: integer
          description: Уникальные пользователи
          example: 140
        first_response_time_seconds:
          type: number
          format: float
          description: Среднее время первого ответа (секунды)
          example: 3600.5
        avg_response_time_seconds:
          type: number
          format: float
          description: Среднее время ответа (секунды)
          example: 1800.0
        busiest_day:
          type: string
          description: Самый активный день недели
          example: "Monday"
        busiest_time_slot:
          type: string
          description: Самый активный временной слот
          example: "14:00-15:00"
        total_messages_sent:
          type: integer
          description: Всего отправлено сообщений
          example: 500
        total_messages_received:
          type: integer
          description: Всего получено сообщений
          example: 450

    HeatmapCell:
      type: object
      required:
        - day
        - hour
        - count
      properties:
        day:
          type: integer
          description: День недели (0 = воскресенье, 6 = суббота)
          minimum: 0
          maximum: 6
          example: 1
        hour:
          type: integer
          description: Час (0-23)
          minimum: 0
          maximum: 23
          example: 14
        count:
          type: integer
          description: Количество сообщений
          example: 25

    DirectHeatmap:
      type: object
      required:
        - cells
      properties:
        cells:
          type: array
          items:
            $ref: '#/components/schemas/HeatmapCell'
          description: Ячейки тепловой карты

    # Template schemas
    TemplateType:
      type: string
      enum:
        - direct
        - comment
        - both
      description: |
        Тип шаблона:
        * `direct` - Только для Direct Messages
        * `comment` - Только для комментариев
        * `both` - Для обоих типов

    Template:
      type: object
      required:
        - id
        - account_id
        - title
        - content
        - type
        - usage_count
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: ID шаблона
          example: "tmpl_abc123"
        account_id:
          type: string
          description: ID аккаунта
          example: "acc_123"
        title:
          type: string
          description: Название шаблона
          maxLength: 255
          example: "Приветствие"
        content:
          type: string
          description: Текст шаблона
          maxLength: 2200
          example: "Привет! Спасибо за обращение."
        images:
          type: array
          items:
            type: string
            format: uri
          description: URL изображений
          example: ["https://storage.example.com/img1.jpg"]
        icon:
          type: string
          description: Иконка шаблона (emoji)
          example: "👋"
        type:
          $ref: '#/components/schemas/TemplateType'
        usage_count:
          type: integer
          description: Количество использований
          example: 42
        created_at:
          type: string
          format: date-time
          description: Дата создания
        updated_at:
          type: string
          format: date-time
          description: Дата обновления

    TemplatesResponse:
      type: object
      required:
        - templates
        - total
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/Template'
        total:
          type: integer
          description: Общее количество шаблонов
          example: 15
        limit:
          type: integer
          example: 50
        offset:
          type: integer
          example: 0

    CreateTemplateRequest:
      type: object
      required:
        - account_id
        - title
        - content
        - type
      properties:
        account_id:
          type: string
          description: ID аккаунта
          example: "acc_123"
        title:
          type: string
          description: Название шаблона
          maxLength: 255
          example: "Приветствие"
        content:
          type: string
          description: Текст шаблона
          maxLength: 2200
          example: "Привет! Спасибо за обращение."
        images:
          type: array
          items:
            type: string
            format: uri
          description: URL изображений
        icon:
          type: string
          description: Иконка шаблона (emoji)
          example: "👋"
        type:
          $ref: '#/components/schemas/TemplateType'

    UpdateTemplateRequest:
      type: object
      properties:
        title:
          type: string
          description: Название шаблона
          maxLength: 255
        content:
          type: string
          description: Текст шаблона
          maxLength: 2200
        images:
          type: array
          items:
            type: string
            format: uri
          description: URL изображений
        icon:
          type: string
          description: Иконка шаблона (emoji)
        type:
          $ref: '#/components/schemas/TemplateType'

  parameters:
    AccountId:
      name: id
      in: path
      required: true
      description: ID аккаунта
      schema:
        type: string
      example: "acc_123"

    PublicationId:
      name: id
      in: path
      required: true
      description: ID публикации
      schema:
        type: string
      example: "pub_xyz789"

    CommentId:
      name: commentId
      in: path
      required: true
      description: ID комментария в Instagram
      schema:
        type: string
      example: "17895695668004551"

    ConversationId:
      name: conversationId
      in: path
      required: true
      description: ID диалога
      schema:
        type: string
      example: "aWdtOjE3ODQxNDAw"

    TemplateId:
      name: templateId
      in: path
      required: true
      description: ID шаблона
      schema:
        type: string
      example: "tmpl_abc123"

  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            validation:
              summary: Ошибка валидации
              value:
                error: "at least one media item is required"
            invalidType:
              summary: Неверный тип
              value:
                error: "invalid publication type"

    NotFound:
      description: Публикация не найдена
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "publication not found"

    InternalError:
      description: Внутренняя ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "internal server error"
